#!/bin/bash

cve="$1"

if [[ ! -d /app ]]; then
  echo "ERROR: /app (i.e. the dockerized app) is not mounted!" 1>&2
  exit 1
fi

if [[ ! -d /app/exploit* ]]; then
  num_of_exploits=$(ls -d /app/exploit* | wc -l)
  if [ $num_of_exploits -lt 1 ]; then
    echo "ERROR: no exploits found for ${cve}!" 1>&2
    exit 1
  fi
fi

# FIXME: If there is more than one exploit, then probably the thing to do would
#        be to run each one in a separate docker instance.  Otherwise, each
#        running exploit code affect subsequently run exploits.
for f in $(ls -d /app/exploit*)
do
   pushd $f
   ./test_exploit 0 172.17.0.2 80 -1 172.17.0.1 5000
   exit_code=$?
   popd;
   if [[ $exit_code != 0 ]]; then
     echo "ERROR: unexpected exit code from exploit ($exit_code)" 1>&2
     exit $exit_code
   fi
done
